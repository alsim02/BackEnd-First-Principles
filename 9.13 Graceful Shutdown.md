# Appunti: Graceful Shutdown

## 1. Introduzione al problema
- Scenario realistico: Il server deve riavviarsi per un deployment mentre elabora una transazione critica.
- Preoccupazioni: evitare perdita di dati, doppie transazioni, corruzione.
- Soluzione nota: **graceful shutdown**.

## 2. Cos’è il graceful shutdown
- Arresto pulito e ordinato di un server o applicazione.
- Il server non si chiude bruscamente ma completa le attività in corso, libera risorse e chiude "la porta" con buone maniere.
- Migliora l’esperienza utente e previene problemi di inconsistenza o errori.

## 3. Ciclo di vita di un processo
- Ogni applicazione gira come un *processo* nel sistema operativo.
- Il processo nasce (start), vive (run) e muore (exit).
- Il sistema operativo comunica al processo quando deve terminare tramite segnali (signals).

## 4. Comunicazione via segnali nel sistema operativo Unix/Linux
- Segnali sono usati per comunicare tra processi (IPC).
- L’applicazione registra handler per gestire specifici segnali.

## 5. Tipi principali di segnali per shutdown
- **SIGTERM (signal terminate):** segnale "politely request" per chiudere il processo, dando tempo di pulire.
- **SIGINT (signal interrupt):** segnale generato da Ctrl+C da terminale, usato in sviluppo; simile a SIGTERM.
- **SIGKILL:** segnale "kill brutale" che termina immediatamente il processo senza possibilità di cleanup; non può essere ignorato o intercettato.

## 6. Perché SIGTERM è importante
- Permette al processo di:
  - Fermare di accettare nuove richieste.
  - Completare le richieste in corso (in-flight requests).
  - Pulire risorse (connessioni DB, file handle, cache).
  - Terminare in modo ordinato.

## 7. Concetto di connection draining
- Processo smette di accettare nuove richieste, ma lascia finire quelle correnti.
- Paragone con ristorante che chiude: non fa entrare nuovi clienti ma lascia finire di mangiare i presenti offrendo tempo per andarsene.

## 8. Cleanup risorse
- Liberare handles di file, connessioni di rete e database.
- Chiudere transazioni DB pendenti (commit o rollback).
- Pulire cache o altre risorse temporanee.
- Pulire nell’ordine inverso di acquisizione risorse.

## 9. Timeout e limiti durante shutdown
- Timeout massimo per attendere completamento richieste, es. 30 secondi.
- Timeout deve bilanciare tra permettere completamento e non rallentare eccessivamente il deploy.
- Se timeout scade, il processo viene forzatamente terminato (es. SIGKILL).

## 10. Implementazione pratica (esempio in Go)
- Registrazione di handler per SIGTERM e SIGINT.
- Chiamata a metodi forniti da framework HTTP per fermare il server (stop accepting new requests, finish inflight requests).
- Chiusura connessione DB e risorse esterne come Redis.
- Logging dello stato per monitorare shutdown.
- Uso di segnali SIGINT per sviluppo (Ctrl+C) e SIGTERM per produzione/orchestratori (es. Kubernetes).

## 11. Conclusioni
- Graceful shutdown è essenziale per sistemi resilienti senza downtime o perdita dati.
- Fondamentale per deployment continui e zero downtime.
- Librerie e framework spesso forniscono già il supporto, ma è importante capire il processo.

---
